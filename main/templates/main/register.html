{% extends 'base.html' %} {% block title %}Register - NarraPro{% endblock %}
{% block content %}
<div class="row justify-content-center">
	<div class="col-lg-8">
		<div class="card shadow">
			<div class="card-header bg-primary text-white text-center">
				<h4 class="mb-0">
					<i class="fas fa-user-plus me-2"></i>
					Register for NarraPro
				</h4>
			</div>
			<div class="card-body">
				<form method="post" enctype="multipart/form-data" id="registrationForm">
					{% csrf_token %}

					<!-- Base User Fields -->
					<div class="row g-3">
						<div class="col-md-6">
							<label
								for="{{ base_form.first_name.id_for_label }}"
								class="form-label"
								>First Name *</label
							>
							{{ base_form.first_name }}
							{% if base_form.first_name.errors %}
								<div class="invalid-feedback d-block">
									{% for error in base_form.first_name.errors %}
										{{ error }}
									{% endfor %}
								</div>
							{% endif %}
						</div>
						<div class="col-md-6">
							<label
								for="{{ base_form.last_name.id_for_label }}"
								class="form-label"
								>Last Name *</label
							>
							{{ base_form.last_name }}
							{% if base_form.last_name.errors %}
								<div class="invalid-feedback d-block">
									{% for error in base_form.last_name.errors %}
										{{ error }}
									{% endfor %}
								</div>
							{% endif %}
						</div>
						<div class="col-md-6">
							<label
								for="{{ base_form.username.id_for_label }}"
								class="form-label"
								>Username *</label
							>
							{{ base_form.username }}
							{% if base_form.username.errors %}
								<div class="invalid-feedback d-block">
									{% for error in base_form.username.errors %}
										{{ error }}
									{% endfor %}
								</div>
							{% endif %}
						</div>
						<div class="col-md-6">
							<label for="{{ base_form.email.id_for_label }}" class="form-label"
								>Email Address *</label
							>
							{{ base_form.email }}
							{% if base_form.email.errors %}
								<div class="invalid-feedback d-block">
									{% for error in base_form.email.errors %}
										{{ error }}
									{% endfor %}
								</div>
							{% endif %}
						</div>
						<div class="col-md-6">
							<label
								for="{{ base_form.password1.id_for_label }}"
								class="form-label"
								>Password *</label
							>
							{{ base_form.password1 }}
							{% if base_form.password1.errors %}
								<div class="invalid-feedback d-block">
									{% for error in base_form.password1.errors %}
										{{ error }}
									{% endfor %}
								</div>
							{% endif %}
						</div>
						<div class="col-md-6">
							<label
								for="{{ base_form.password2.id_for_label }}"
								class="form-label"
								>Confirm Password *</label
							>
							{{ base_form.password2 }}
							{% if base_form.password2.errors %}
								<div class="invalid-feedback d-block">
									{% for error in base_form.password2.errors %}
										{{ error }}
									{% endfor %}
								</div>
							{% endif %}
						</div>
					</div>

					<hr class="my-4" />

					<!-- User Type Selection -->
					<div class="mb-4">
						<label
							for="{{ base_form.user_type.id_for_label }}"
							class="form-label"
						>
							<strong>I want to register as:</strong> *
						</label>
						{{ base_form.user_type }}
						{% if base_form.user_type.errors %}
							<div class="invalid-feedback d-block">
								{% for error in base_form.user_type.errors %}
									{{ error }}
								{% endfor %}
							</div>
						{% endif %}
						<div class="form-text">
							Choose your role: Narasumber (expert/speaker) or Event Organizer
						</div>
					</div>

					<!-- Dynamic Role-Specific Fields -->
					<div id="roleSpecificFields">
						{% if selected_user_type == 'narasumber' %}
							{% include 'main/partials/narasumber_fields.html' with form=narasumber_form %}
						{% elif selected_user_type == 'event' %}
							{% include 'main/partials/event_fields.html' with form=event_form %}
						{% elif selected_user_type == 'pengguna' %}
							{% include 'main/partials/pengguna_form_fields.html' %}
						{% else %}
							<div class="text-center text-muted py-4">
								<i class="fas fa-arrow-up fa-2x mb-2"></i>
								<p>Please select your role above to continue</p>
							</div>
						{% endif %}
					</div>

					<!-- Submit Button -->
					<div class="d-grid mt-4">
						<button
							type="submit"
							class="btn btn-primary btn-lg"
							id="submitBtn"
							{% if not selected_user_type %}disabled{% endif %}
						>
							<i class="fas fa-user-plus me-2"></i>
							Register
						</button>
					</div>
				</form>
			</div>
			<div class="card-footer text-center">
				<small class="text-muted">
					Already have an account?
					<a href="{% url 'main:login' %}" class="text-decoration-none">
						Login here
					</a>
				</small>
			</div>
		</div>
	</div>
</div>

<!-- Add Font Awesome for icons -->
<link
	rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
/>
{% endblock %}

{% block extra_head %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/auto-crop-widget.css' %}">
<style>
	/* Style for fields with errors */
	.is-invalid, .form-control.is-invalid, .form-select.is-invalid {
		border-color: #dc3545 !important;
		padding-right: calc(1.5em + 0.75rem);
		background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
		background-repeat: no-repeat;
		background-position: right calc(0.375em + 0.1875rem) center;
		background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
	}

	.invalid-feedback {
		display: none;
		width: 100%;
		margin-top: 0.25rem;
		font-size: 0.875em;
		color: #dc3545;
	}

	.invalid-feedback.d-block {
		display: block;
	}
</style>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/auto-crop-widget.js' %}"></script>
<script src="{% static 'js/education-form-handler.js' %}"></script>
<script src="{% static 'js/certification-form-handler.js' %}"></script>
<script src="{% static 'js/event-form-handler.js' %}"></script>
<script>
	document.addEventListener('DOMContentLoaded', function () {
		const userTypeSelect = document.getElementById('user_type_select');
		const roleSpecificFields = document.getElementById('roleSpecificFields');
		const submitBtn = document.getElementById('submitBtn');

		// Set the selected user type on page load (for form errors)
		{% if selected_user_type %}
			userTypeSelect.value = '{{ selected_user_type }}';
			// Initialize widgets for pre-loaded content
			setTimeout(() => {
				initializeWidgetsForContent(roleSpecificFields, '{{ selected_user_type }}');
				// Reapply invalid classes after widgets are initialized
				setTimeout(() => applyInvalidClass(), 100);
			}, 100);
		{% endif %}

		// Add is-invalid class to fields with errors
		function applyInvalidClass() {
			document.querySelectorAll('.invalid-feedback.d-block').forEach(function(errorDiv) {
				// Find the nearest input/select/textarea before this error div
				let inputField = errorDiv.previousElementSibling;

				// Handle cases where the input might be wrapped in a div
				if (inputField && inputField.classList.contains('enhanced-image-widget')) {
					inputField = inputField.querySelector('input');
				}

				if (inputField) {
					if (inputField.classList.contains('form-control') ||
						inputField.classList.contains('form-select') ||
						inputField.tagName === 'INPUT' ||
						inputField.tagName === 'SELECT' ||
						inputField.tagName === 'TEXTAREA') {
						inputField.classList.add('is-invalid');
					}
				}
			});
		}

		// Apply invalid class on page load
		applyInvalidClass();

		function initializeWidgetsForContent(container, selectedType) {
			console.log('ðŸ”µ Initializing widgets for:', selectedType);

			// Initialize social media widgets
			if (window.initializeSocialMediaWidget) {
				console.log('ðŸ”µ Calling initializeSocialMediaWidget');
				window.initializeSocialMediaWidget(container);
			}

			// Initialize auto-crop widgets
			const profileWidgets = container.querySelectorAll('.enhanced-image-widget[data-type="profile"]');
			profileWidgets.forEach((widget) => {
				new AutoCropWidget(widget, {
					aspectRatio: 1,
					maxSizeKB: 1024,
					outputWidth: 800
				});
			});

			const coverWidgets = container.querySelectorAll('.enhanced-image-widget[data-type="cover"]');
			coverWidgets.forEach((widget) => {
				new AutoCropWidget(widget, {
					aspectRatio: 4,
					maxSizeKB: 4096,
					outputWidth: 1200
				});
			});

			// Initialize education forms for narasumber
			if (selectedType === 'narasumber' && window.initializeEducationForms) {
				console.log('ðŸ”µ Calling initializeEducationForms');
				window.initializeEducationForms(container);
			}

			// Initialize certification forms for narasumber
			if (selectedType === 'narasumber' && window.initializeCertificationForms) {
				console.log('ðŸ”µ Calling initializeCertificationForms');
				window.initializeCertificationForms(container);
			}

			// Initialize event form handler for event organizers
			if (selectedType === 'event' && window.initializeEventFormHandler) {
				console.log('ðŸ”µ Calling initializeEventFormHandler');
				window.initializeEventFormHandler(container);
			}
		}

		userTypeSelect.addEventListener('change', function () {
			const selectedType = this.value;

			if (selectedType) {
				
				// Show loading
				roleSpecificFields.innerHTML = `
                <div class="text-center text-muted py-4">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Loading ${selectedType} fields...
                </div>
            `;

				// Fetch role-specific fields
				fetch(`{% url 'main:get_role_form_fields' %}?user_type=${selectedType}`)
					.then((response) => response.json())
					.then((data) => {
						if (data.success) {
							roleSpecificFields.innerHTML = data.html;
							submitBtn.disabled = false;

							console.log('ðŸ”µ AJAX content loaded successfully');
							// Initialize widgets using the centralized function
							setTimeout(() => {
								initializeWidgetsForContent(roleSpecificFields, selectedType);
								// Reapply invalid classes after AJAX load
								setTimeout(() => applyInvalidClass(), 100);
							}, 150);
						} else {
							roleSpecificFields.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Error loading form fields. Please try again.
                            </div>
                        `;
							submitBtn.disabled = true;
						}
					})
					.catch((error) => {
						console.error('Error:', error);
						roleSpecificFields.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Network error. Please check your connection and try again.
                        </div>
                    `;
						submitBtn.disabled = true;
					});
			} else {
				roleSpecificFields.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-arrow-up fa-2x mb-2"></i>
                    <p>Please select your role above to continue</p>
                </div>
            `;
				submitBtn.disabled = true;
			}
		});
	});
</script>
{% endblock %}
