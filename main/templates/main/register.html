{% extends 'base.html' %} {% block title %}Register - NarraPro{% endblock %}
{% block content %}
<div class="row justify-content-center">
	<div class="col-lg-8">
		<div class="card shadow">
			<div class="card-header bg-primary text-white text-center">
				<h4 class="mb-0">
					<i class="fas fa-user-plus me-2"></i>
					Register for NarraPro
				</h4>
			</div>
			<div class="card-body">
				<form method="post" enctype="multipart/form-data" id="registrationForm">
					{% csrf_token %}

					<!-- Base User Fields -->
					<div class="row g-3">
						<div class="col-md-6">
							<label
								for="{{ base_form.first_name.id_for_label }}"
								class="form-label"
								>First Name *</label
							>
							{{ base_form.first_name }}
						</div>
						<div class="col-md-6">
							<label
								for="{{ base_form.last_name.id_for_label }}"
								class="form-label"
								>Last Name *</label
							>
							{{ base_form.last_name }}
						</div>
						<div class="col-md-6">
							<label
								for="{{ base_form.username.id_for_label }}"
								class="form-label"
								>Username *</label
							>
							{{ base_form.username }}
						</div>
						<div class="col-md-6">
							<label for="{{ base_form.email.id_for_label }}" class="form-label"
								>Email Address *</label
							>
							{{ base_form.email }}
						</div>
						<div class="col-md-6">
							<label
								for="{{ base_form.password1.id_for_label }}"
								class="form-label"
								>Password *</label
							>
							{{ base_form.password1 }}
						</div>
						<div class="col-md-6">
							<label
								for="{{ base_form.password2.id_for_label }}"
								class="form-label"
								>Confirm Password *</label
							>
							{{ base_form.password2 }}
						</div>
					</div>

					<hr class="my-4" />

					<!-- User Type Selection -->
					<div class="mb-4">
						<label
							for="{{ base_form.user_type.id_for_label }}"
							class="form-label"
						>
							<strong>I want to register as:</strong> *
						</label>
						{{ base_form.user_type }}
						<div class="form-text">
							Choose your role: Narasumber (expert/speaker) or Event Organizer
						</div>
					</div>

					<!-- Dynamic Role-Specific Fields -->
					<div id="roleSpecificFields">
						<div class="text-center text-muted py-4">
							<i class="fas fa-arrow-up fa-2x mb-2"></i>
							<p>Please select your role above to continue</p>
						</div>
					</div>

					<!-- Submit Button -->
					<div class="d-grid mt-4">
						<button
							type="submit"
							class="btn btn-primary btn-lg"
							id="submitBtn"
							disabled
						>
							<i class="fas fa-user-plus me-2"></i>
							Register
						</button>
					</div>
				</form>
			</div>
			<div class="card-footer text-center">
				<small class="text-muted">
					Already have an account?
					<a href="{% url 'main:login' %}" class="text-decoration-none">
						Login here
					</a>
				</small>
			</div>
		</div>
	</div>
</div>

<!-- Add Font Awesome for icons -->
<link
	rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
/>
{% endblock %}

{% block extra_head %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/auto-crop-widget.css' %}">
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/auto-crop-widget.js' %}"></script>
<script src="{% static 'js/education-form-handler.js' %}"></script>
<script src="{% static 'js/event-form-handler.js' %}"></script>
<script>
	document.addEventListener('DOMContentLoaded', function () {
		const userTypeSelect = document.getElementById('user_type_select');
		const roleSpecificFields = document.getElementById('roleSpecificFields');
		const submitBtn = document.getElementById('submitBtn');

		userTypeSelect.addEventListener('change', function () {
			const selectedType = this.value;

			if (selectedType) {
				
				// Show loading
				roleSpecificFields.innerHTML = `
                <div class="text-center text-muted py-4">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Loading ${selectedType} fields...
                </div>
            `;

				// Fetch role-specific fields
				fetch(`{% url 'main:get_role_form_fields' %}?user_type=${selectedType}`)
					.then((response) => response.json())
					.then((data) => {
						if (data.success) {
							roleSpecificFields.innerHTML = data.html;
							submitBtn.disabled = false;
							
							console.log('ðŸ”µ AJAX content loaded successfully');
							// Initialize social media widgets for newly loaded content
							if (window.initializeSocialMediaWidget) {
								console.log('ðŸ”µ Calling initializeSocialMediaWidget for AJAX content');
								window.initializeSocialMediaWidget(roleSpecificFields);
							} else {
								console.error('ðŸ”´ initializeSocialMediaWidget function not found!');
							}

							// Initialize auto-crop widgets for newly loaded content
							setTimeout(() => {
								// Profile picture widgets (1:1 ratio, 1MB)
								const profileWidgets = roleSpecificFields.querySelectorAll('.enhanced-image-widget[data-type="profile"]');
								profileWidgets.forEach((widget) => {
									new AutoCropWidget(widget, {
										aspectRatio: 1,
										maxSizeKB: 1024,
										outputWidth: 800
									});
								});

								// Cover image widgets (4:1 ratio, 4MB)
								const coverWidgets = roleSpecificFields.querySelectorAll('.enhanced-image-widget[data-type="cover"]');
								coverWidgets.forEach((widget) => {
									new AutoCropWidget(widget, {
										aspectRatio: 4,
										maxSizeKB: 4096,
										outputWidth: 1200
									});
								});
							}, 150);

							// Initialize education forms for narasumber
							if (selectedType === 'narasumber' && window.initializeEducationForms) {
								console.log('ðŸ”µ Calling initializeEducationForms for AJAX content');
								// Add a small delay to ensure the DOM is fully ready
								setTimeout(() => {
									window.initializeEducationForms(roleSpecificFields);
								}, 100);
							}

							// Initialize event form handler for event organizers
							if (selectedType === 'event' && window.initializeEventFormHandler) {
								console.log('ðŸ”µ Calling initializeEventFormHandler for AJAX content');
								// Add a small delay to ensure the DOM is fully ready
								setTimeout(() => {
									window.initializeEventFormHandler(roleSpecificFields);
								}, 100);
							}
						} else {
							roleSpecificFields.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Error loading form fields. Please try again.
                            </div>
                        `;
							submitBtn.disabled = true;
						}
					})
					.catch((error) => {
						console.error('Error:', error);
						roleSpecificFields.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Network error. Please check your connection and try again.
                        </div>
                    `;
						submitBtn.disabled = true;
					});
			} else {
				roleSpecificFields.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-arrow-up fa-2x mb-2"></i>
                    <p>Please select your role above to continue</p>
                </div>
            `;
				submitBtn.disabled = true;
			}
		});
	});
</script>
{% endblock %}
