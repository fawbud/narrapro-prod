{% extends 'base.html' %}

{% block title %}Edit Profil - NarraPro{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Edit Profil</h5>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Basic User Information -->
                    <h6 class="text-muted mb-3">Informasi Dasar</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ user_form.first_name.id_for_label }}" class="form-label">
                                {{ user_form.first_name.label }}
                            </label>
                            {{ user_form.first_name }}
                            {% if user_form.first_name.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in user_form.first_name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ user_form.last_name.id_for_label }}" class="form-label">
                                {{ user_form.last_name.label }}
                            </label>
                            {{ user_form.last_name }}
                            {% if user_form.last_name.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in user_form.last_name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ user_form.username.id_for_label }}" class="form-label">
                                {{ user_form.username.label }}
                            </label>
                            {{ user_form.username }}
                            {% if user_form.username.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in user_form.username.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ user_form.email.id_for_label }}" class="form-label">
                                {{ user_form.email.label }}
                            </label>
                            {{ user_form.email }}
                            {% if user_form.email.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in user_form.email.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Tipe User</label>
                        <p class="form-control-plaintext">{{ profile_user.get_user_type_display }}</p>
                        <small class="text-muted">Tipe user tidak dapat diubah.</small>
                    </div>
                    
                    <!-- User Type Specific Information -->
                    {% if narasumber_form %}
                    <hr class="my-4">
                    <h6 class="text-narasumber mb-3"><i class="fas fa-user-graduate me-2"></i>Informasi Narasumber</h6>
                    
                    <div class="mb-3">
                        <label for="{{ narasumber_form.profile_picture.id_for_label }}" class="form-label">
                            {{ narasumber_form.profile_picture.label }}
                        </label>
                        <div class="enhanced-image-widget" data-type="profile">
                            {{ narasumber_form.profile_picture }}
                        </div>
                        {% if narasumber_form.profile_picture.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in narasumber_form.profile_picture.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Upload a professional photo. Image will be automatically cropped to 1:1 ratio and compressed to max 1MB.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ narasumber_form.full_name.id_for_label }}" class="form-label">
                            {{ narasumber_form.full_name.label }}
                        </label>
                        {{ narasumber_form.full_name }}
                        {% if narasumber_form.full_name.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in narasumber_form.full_name.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ narasumber_form.bio.id_for_label }}" class="form-label">
                            {{ narasumber_form.bio.label }}
                        </label>
                        {{ narasumber_form.bio }}
                        {% if narasumber_form.bio.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in narasumber_form.bio.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ narasumber_form.expertise_area.id_for_label }}" class="form-label">
                                {{ narasumber_form.expertise_area.label }}
                            </label>
                            {{ narasumber_form.expertise_area }}
                            {% if narasumber_form.expertise_area.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in narasumber_form.expertise_area.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ narasumber_form.experience_level.id_for_label }}" class="form-label">
                                {{ narasumber_form.experience_level.label }}
                            </label>
                            {{ narasumber_form.experience_level }}
                            {% if narasumber_form.experience_level.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in narasumber_form.experience_level.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ narasumber_form.years_of_experience.id_for_label }}" class="form-label">
                                {{ narasumber_form.years_of_experience.label }}
                            </label>
                            {{ narasumber_form.years_of_experience }}
                            {% if narasumber_form.years_of_experience.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in narasumber_form.years_of_experience.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ narasumber_form.location.id_for_label }}" class="form-label">
                                {{ narasumber_form.location.label }}
                            </label>
                            {{ narasumber_form.location }}
                            {% if narasumber_form.location.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in narasumber_form.location.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ narasumber_form.email.id_for_label }}" class="form-label">
                                {{ narasumber_form.email.label }}
                            </label>
                            {{ narasumber_form.email }}
                            {% if narasumber_form.email.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in narasumber_form.email.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ narasumber_form.phone_number.id_for_label }}" class="form-label">
                                {{ narasumber_form.phone_number.label }}
                            </label>
                            {{ narasumber_form.phone_number }}
                            {% if narasumber_form.phone_number.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in narasumber_form.phone_number.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            {{ narasumber_form.is_phone_public }}
                            <label class="form-check-label" for="{{ narasumber_form.is_phone_public.id_for_label }}">
                                {{ narasumber_form.is_phone_public.label }}
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ narasumber_form.portfolio_link.id_for_label }}" class="form-label">
                            {{ narasumber_form.portfolio_link.label }}
                        </label>
                        {{ narasumber_form.portfolio_link }}
                        {% if narasumber_form.portfolio_link.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in narasumber_form.portfolio_link.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ narasumber_form.linkedin_url.id_for_label }}" class="form-label">
                            {{ narasumber_form.linkedin_url.label }}
                        </label>
                        {{ narasumber_form.linkedin_url }}
                        {% if narasumber_form.linkedin_url.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in narasumber_form.linkedin_url.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Add your LinkedIn profile URL (optional). Example: https://linkedin.com/in/your-username
                        </div>
                    </div>
                    
                    <!-- Education Section -->
                    {% if education_formset %}
                    <hr class="my-4">
                    <h6 class="text-narasumber mb-3"><i class="fas fa-graduation-cap me-2"></i>Riwayat Pendidikan</h6>
                    {{ education_formset.management_form }}
                    
                    <div id="education-formset">
                        {% for form in education_formset %}
                        <div class="border rounded p-3 mb-3 education-form" data-form-index="{{ forloop.counter0 }}" {% if forloop.last %}style="border-color: #0d6efd !important;"{% endif %}>
                            {% if form.non_field_errors %}
                                <div class="alert alert-danger">
                                    {{ form.non_field_errors }}
                                </div>
                            {% endif %}
                            
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">
                                    {% if forloop.first %}
                                        Pendidikan Utama
                                    {% else %}
                                        Pendidikan {{ forloop.counter }}
                                    {% endif %}
                                </h6>
                                {% if not forloop.first %}
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-education-form-btn">
                                        <i class="fas fa-trash me-1"></i>Hapus
                                    </button>
                                {% endif %}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.degree.id_for_label }}" class="form-label">
                                        {{ form.degree.label }}
                                    </label>
                                    {{ form.degree }}
                                    {% if form.degree.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.degree.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.school_university.id_for_label }}" class="form-label">
                                        {{ form.school_university.label }}
                                    </label>
                                    {{ form.school_university }}
                                    {% if form.school_university.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.school_university.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.field_of_study.id_for_label }}" class="form-label">
                                        {{ form.field_of_study.label }}
                                    </label>
                                    {{ form.field_of_study }}
                                    {% if form.field_of_study.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.field_of_study.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.graduation_year.id_for_label }}" class="form-label">
                                        {{ form.graduation_year.label }}
                                    </label>
                                    {{ form.graduation_year }}
                                    {% if form.graduation_year.errors %}
                                        <div class="text-danger small mt-1">
                                            {% for error in form.graduation_year.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Hidden DELETE field (will be set via JavaScript) -->
                            {% if form.DELETE %}
                                <div style="display: none;">
                                    {{ form.DELETE }}
                                </div>
                            {% endif %}
                            
                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="text-muted small mb-3">
                        <i class="fas fa-info-circle me-1"></i>
                        Anda dapat menambah, mengedit, atau menghapus entry pendidikan. Kosongkan field yang tidak relevan.
                    </div>
                    
                    <button type="button" id="add-education-form" class="btn btn-outline-primary btn-sm mb-3">
                        <i class="fas fa-plus me-1"></i>Tambah Pendidikan Baru
                    </button>
                    {% endif %}
                    
                    {% elif event_form %}
                    <hr class="my-4">
                    <h6 class="text-event mb-3"><i class="fas fa-calendar-alt me-2"></i>Informasi Event Organizer</h6>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="{{ event_form.name.id_for_label }}" class="form-label">
                                {{ event_form.name.label }}
                            </label>
                            {{ event_form.name }}
                            {% if event_form.name.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in event_form.name.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ event_form.description.id_for_label }}" class="form-label">
                            {{ event_form.description.label }}
                        </label>
                        {{ event_form.description }}
                        {% if event_form.description.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in event_form.description.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ event_form.event_type.id_for_label }}" class="form-label">
                                {{ event_form.event_type.label }}
                            </label>
                            {{ event_form.event_type }}
                            {% if event_form.event_type.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in event_form.event_type.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ event_form.location.id_for_label }}" class="form-label">
                                {{ event_form.location.label }}
                            </label>
                            {{ event_form.location }}
                            {% if event_form.location.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in event_form.location.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ event_form.target_audience.id_for_label }}" class="form-label">
                            {{ event_form.target_audience.label }}
                        </label>
                        {{ event_form.target_audience }}
                        {% if event_form.target_audience.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in event_form.target_audience.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            Describe your intended audience (e.g., "Professionals, Students, General Public")
                        </div>
                    </div>
                    
                    <div class="row">
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ event_form.email.id_for_label }}" class="form-label">
                                {{ event_form.email.label }}
                            </label>
                            {{ event_form.email }}
                            {% if event_form.email.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in event_form.email.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ event_form.phone_number.id_for_label }}" class="form-label">
                                {{ event_form.phone_number.label }}
                            </label>
                            {{ event_form.phone_number }}
                            {% if event_form.phone_number.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in event_form.phone_number.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                {{ event_form.is_phone_public }}
                                <label for="{{ event_form.is_phone_public.id_for_label }}" class="form-check-label">
                                    {{ event_form.is_phone_public.label }}
                                </label>
                            </div>
                            {% if event_form.is_phone_public.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in event_form.is_phone_public.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ event_form.website.id_for_label }}" class="form-label">
                            {{ event_form.website.label }}
                        </label>
                        {{ event_form.website }}
                        {% if event_form.website.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in event_form.website.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ event_form.linkedin_url.id_for_label }}" class="form-label">
                            {{ event_form.linkedin_url.label }}
                        </label>
                        {{ event_form.linkedin_url }}
                        {% if event_form.linkedin_url.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in event_form.linkedin_url.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Add your LinkedIn profile URL (optional). Example: https://linkedin.com/in/your-username
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ event_form.cover_image.id_for_label }}" class="form-label">
                            {{ event_form.cover_image.label }}
                        </label>
                        <div class="enhanced-image-widget" data-type="cover">
                            {{ event_form.cover_image }}
                        </div>
                        {% if event_form.cover_image.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in event_form.cover_image.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Upload a cover image for your event or organization. Image will be automatically cropped to 4:1 ratio and compressed to max 4MB.
                        </div>
                    </div>
                    
                    <h6 class="text-muted mb-3">Tanggal Event (Opsional)</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ event_form.start_date.id_for_label }}" class="form-label">
                                {{ event_form.start_date.label }}
                            </label>
                            {{ event_form.start_date }}
                            {% if event_form.start_date.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in event_form.start_date.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ event_form.end_date.id_for_label }}" class="form-label">
                                {{ event_form.end_date.label }}
                            </label>
                            {{ event_form.end_date }}
                            {% if event_form.end_date.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in event_form.end_date.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    {% elif pengguna_form %}
                    <hr class="my-4">
                    <h6 class="text-primary mb-3"><i class="fas fa-user me-2"></i>Informasi Pengguna</h6>

                    <div class="mb-3">
                        <label for="{{ pengguna_form.profile_picture.id_for_label }}" class="form-label">
                            {{ pengguna_form.profile_picture.label }}
                        </label>
                        <div class="enhanced-image-widget" data-type="profile">
                            {{ pengguna_form.profile_picture }}
                        </div>
                        {% if pengguna_form.profile_picture.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in pengguna_form.profile_picture.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Upload a clear profile picture. Image will be automatically cropped to 1:1 ratio and compressed to max 1MB.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ pengguna_form.bio.id_for_label }}" class="form-label">
                            {{ pengguna_form.bio.label }}
                        </label>
                        {{ pengguna_form.bio }}
                        {% if pengguna_form.bio.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in pengguna_form.bio.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ pengguna_form.email.id_for_label }}" class="form-label">
                                {{ pengguna_form.email.label }}
                            </label>
                            {{ pengguna_form.email }}
                            {% if pengguna_form.email.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in pengguna_form.email.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ pengguna_form.phone_number.id_for_label }}" class="form-label">
                                {{ pengguna_form.phone_number.label }}
                            </label>
                            {{ pengguna_form.phone_number }}
                            {% if pengguna_form.phone_number.errors %}
                                <div class="text-danger small mt-1">
                                    {% for error in pengguna_form.phone_number.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ pengguna_form.is_phone_public }}
                            <label class="form-check-label" for="{{ pengguna_form.is_phone_public.id_for_label }}">
                                {{ pengguna_form.is_phone_public.label }}
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ pengguna_form.website.id_for_label }}" class="form-label">
                            {{ pengguna_form.website.label }}
                        </label>
                        {{ pengguna_form.website }}
                        {% if pengguna_form.website.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in pengguna_form.website.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ pengguna_form.linkedin_url.id_for_label }}" class="form-label">
                            {{ pengguna_form.linkedin_url.label }}
                        </label>
                        {{ pengguna_form.linkedin_url }}
                        {% if pengguna_form.linkedin_url.errors %}
                            <div class="text-danger small mt-1">
                                {% for error in pengguna_form.linkedin_url.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            Add your LinkedIn profile URL (optional). Example: https://linkedin.com/in/your-username
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'profiles:profile_detail' profile_user.username %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>Kembali
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Simpan Perubahan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/auto-crop-widget.js' %}"></script>
<script src="{% static 'js/event-form-handler.js' %}"></script>
<script src="{% static 'js/education-form-handler.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize auto-crop widgets for profile pictures
    const profileWidgets = document.querySelectorAll('.enhanced-image-widget[data-type="profile"]');
    profileWidgets.forEach((widget) => {
        new AutoCropWidget(widget, {
            aspectRatio: 1,
            maxSizeKB: 1024,
            outputWidth: 800
        });
    });

    // Initialize auto-crop widgets for cover images
    const coverWidgets = document.querySelectorAll('.enhanced-image-widget[data-type="cover"]');
    coverWidgets.forEach((widget) => {
        new AutoCropWidget(widget, {
            aspectRatio: 4,
            maxSizeKB: 4096,
            outputWidth: 1200
        });
    });

    // Education form handlers
    const addEducationBtn = document.getElementById('add-education-form');
    const educationFormset = document.getElementById('education-formset');
    const maxForms = 5;
    
    console.log('Edit profile education handler initialized', {
        addEducationBtn: !!addEducationBtn,
        educationFormset: !!educationFormset
    });
    
    function updateAddButtonVisibility() {
        if (!addEducationBtn || !educationFormset) return;

        const currentForms = educationFormset.querySelectorAll('.education-form:not([style*="display: none"])').length;
        if (currentForms >= maxForms) {
            addEducationBtn.style.display = 'none';
        } else {
            addEducationBtn.style.display = 'inline-block';
        }
        console.log('Updated add button visibility', { currentForms, maxForms, visible: currentForms < maxForms });
    }
    
    function updateFormTitles() {
        const forms = educationFormset.querySelectorAll('.education-form:not([style*="display: none"])');
        forms.forEach((form, index) => {
            const title = form.querySelector('h6');
            if (title) {
                title.textContent = index === 0 ? 'Pendidikan Utama' : `Pendidikan ${index + 1}`;
            }
        });
    }
    
    if (addEducationBtn && educationFormset) {
        addEducationBtn.addEventListener('click', function() {
            const totalForms = document.querySelector('#id_educations-TOTAL_FORMS');
            if (!totalForms) return;

            const visibleForms = educationFormset.querySelectorAll('.education-form:not([style*="display: none"])').length;
            const formCount = parseInt(totalForms.value);
            console.log('Add education clicked', { formCount, visibleForms, maxForms });

            if (visibleForms < maxForms) {
                const emptyFormTemplate = educationFormset.querySelector('.education-form:last-child').cloneNode(true);
                
                // Update form indices
                const inputs = emptyFormTemplate.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    const name = input.getAttribute('name');
                    const id = input.getAttribute('id');
                    
                    if (name) {
                        input.setAttribute('name', name.replace(/educations-\d+/, `educations-${formCount}`));
                    }
                    if (id) {
                        input.setAttribute('id', id.replace(/id_educations-\d+/, `id_educations-${formCount}`));
                    }
                    
                    // Clear values
                    if (input.type === 'checkbox') {
                        input.checked = false;
                    } else {
                        input.value = '';
                    }
                });
                
                // Update labels
                const labels = emptyFormTemplate.querySelectorAll('label');
                labels.forEach(label => {
                    const forAttr = label.getAttribute('for');
                    if (forAttr) {
                        label.setAttribute('for', forAttr.replace(/id_educations-\d+/, `id_educations-${formCount}`));
                    }
                });
                
                // Update data attributes
                emptyFormTemplate.setAttribute('data-form-index', formCount);
                
                // Highlight new form and add remove button
                emptyFormTemplate.style.borderColor = '#0d6efd';
                const titleDiv = emptyFormTemplate.querySelector('.d-flex');
                if (titleDiv && !titleDiv.querySelector('.remove-education-form-btn')) {
                    titleDiv.innerHTML = `
                        <h6 class="mb-0">Pendidikan ${visibleForms + 1}</h6>
                        <button type="button" class="btn btn-outline-danger btn-sm remove-education-form-btn">
                            <i class="fas fa-trash me-1"></i>Hapus
                        </button>
                    `;
                }

                educationFormset.appendChild(emptyFormTemplate);
                totalForms.value = formCount + 1;

                updateFormTitles();
                updateAddButtonVisibility();
            }
        });
        
        // Handle remove education
        educationFormset.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-education-form-btn') || e.target.parentElement.classList.contains('remove-education-form-btn')) {
                const educationForm = e.target.closest('.education-form');
                const totalForms = document.querySelector('#id_educations-TOTAL_FORMS');

                if (educationForm && totalForms) {
                    console.log('Removing education form');

                    // Check if this is an existing form (has data) - mark for deletion
                    const deleteInput = educationForm.querySelector('input[name$="-DELETE"]');
                    if (deleteInput) {
                        const hasId = educationForm.querySelector('input[name$="-id"]');
                        if (hasId && hasId.value) {
                            // Existing form - mark for deletion and hide immediately
                            deleteInput.checked = true;
                            educationForm.style.display = 'none';
                        } else {
                            // New form - actually remove
                            educationForm.remove();
                            totalForms.value = parseInt(totalForms.value) - 1;
                        }
                    } else {
                        // No delete input - just remove
                        educationForm.remove();
                        totalForms.value = parseInt(totalForms.value) - 1;
                    }

                    updateFormTitles();
                    updateAddButtonVisibility();
                }
            }
        });
    }
    
    // Initial setup
    updateAddButtonVisibility();
});
</script>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% load static %}
<link rel="stylesheet" href="{% static 'css/auto-crop-widget.css' %}">
<style>
    .form-control, .form-select {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
</style>
{% endblock %}
